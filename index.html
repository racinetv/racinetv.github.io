<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>IPTV Player GitHub.io</title>

<!-- Shaka Player -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.3/shaka-player.compiled.js"></script>
<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- Video.js -->
<link href="https://vjs.zencdn.net/7.24.1/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/7.24.1/video.min.js"></script>
<!-- Plyr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
<script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.min.js"></script>
<!-- MediaElement.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/5.0.5/mediaelementplayer.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/5.0.5/mediaelement-and-player.min.js"></script>
<!-- AfterglowPlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/afterglowplayer@1.6.0/dist/afterglow.css">
<script src="https://cdn.jsdelivr.net/npm/afterglowplayer@1.6.0/dist/afterglow.min.js"></script>

<style>
body { margin:0; background:#000; color:#fff; font-family:sans-serif; overflow:hidden;}
video, .video-js, .plyr__video-embed, .afterglow, .mejs__player {width:100%; height:100vh; object-fit:cover; background:#000;}
#overlay {position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:none;padding:20px;}
#grid {display:grid; grid-template-columns: repeat(4, 1fr); gap:16px;}
.channel {background:rgba(255,255,255,0.05); border-radius:12px; text-align:center; padding:12px; transition:all 0.2s;}
.channel img {width:200px; height:200px; object-fit:contain; margin-bottom:5px;}
.channel.focused {outline:3px solid #00bfff; transform:scale(1.05);}
.channel.active {background:rgba(0,191,255,0.3);}
#epg {position:absolute;bottom:0;left:0;right:0; background:rgba(0,0,0,0.7); padding:12px; font-size:16px;}
#page-indicator {position:absolute; top:10px; right:20px; font-size:14px; color:#bbb;}
#number-osd {position:absolute; top:40%; left:50%; transform:translateX(-50%); font-size:48px; background:rgba(0,0,0,0.6); padding:20px 40px; border-radius:12px; display:none;}
#channel-osd {position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.7); padding:10px 20px; border-radius:12px; display:none; align-items:center; gap:10px;}
#channel-osd img { width:50px; height:50px; object-fit:contain; }
#channel-osd span { font-size:18px; font-weight:bold; }
#loading {position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border:6px solid rgba(255,255,255,0.3); border-top:6px solid #00bfff; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite; display:none;}
@keyframes spin { 100% { transform:translate(-50%,-50%) rotate(360deg); } }
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<div id="overlay"><div id="page-indicator"></div><div id="grid"></div></div>
<div id="epg"></div>
<div id="number-osd"></div>
<div id="channel-osd"><img id="osd-logo"><span id="osd-name"></span></div>
<div id="loading"></div>

<script>
const M3U_URL="https://raw.githubusercontent.com/vnrartv/vnrartv.github.io/main/racinetv_android_tv.m3u";
const pageSize=12, cols=4;

let channels=[], currentIndex=0, focusIndex=0, currentPage=0, overlayVisible=false;
let numberInput="", numberTimer=null, osdTimer=null, zapInterval=null, playerInstance=null, wakeLock=null;

const video=document.getElementById("video");
const overlay=document.getElementById("overlay");
const grid=document.getElementById("grid");
const epgDiv=document.getElementById("epg");
const pageIndicator=document.getElementById("page-indicator");
const numberOSD=document.getElementById("number-osd");
const channelOSD=document.getElementById("channel-osd");
const osdLogo=document.getElementById("osd-logo");
const osdName=document.getElementById("osd-name");
const loading=document.getElementById("loading");

// --- M3U Parser ---
async function loadM3U(url){
  const text=await (await fetch(url)).text();
  const lines=text.split("\n");
  const result=[]; let current={};
  lines.forEach(line=>{
    line=line.trim();
    if(line.startsWith("#EXTINF")){
      const nameMatch=line.match(/,(.*)$/);
      const logoMatch=line.match(/tvg-logo="(.*?)"/);
      current={name:nameMatch?nameMatch[1]:"No name", logo:logoMatch?logoMatch[1]:""};
    } else if(line && !line.startsWith("#")){
      current.url=line;
      current.epg="Đang cập nhật...";
      result.push(current); current={};
    }
  });
  return result;
}

// --- Load channel ---
async function loadChannel(index){
  if(index<0||index>=channels.length) return;
  currentIndex=index;
  const ch=channels[index], url=ch.url.toLowerCase();
  loading.style.display="block";

  if(playerInstance && playerInstance.destroy) playerInstance.destroy();
  video.pause(); video.src=""; video.load();

  try{
    video.muted=false;

    if(url.endsWith(".m3u8")){
      if(Hls.isSupported()){
        const hls=new Hls();
        hls.loadSource(ch.url);
        hls.attachMedia(video);
        await video.play();
        playerInstance=hls;
      } else if(video.canPlayType("application/vnd.apple.mpegurl")){
        video.src=ch.url;
        await video.play();
        playerInstance=video;
      }
    } else if(url.endsWith(".mpd")){
      const shakaPlayer=new shaka.Player(video);
      shakaPlayer.addEventListener("error", e=>console.error(e));
      await shakaPlayer.load(ch.url);
      playerInstance=shakaPlayer;
      await video.play();
    } else {
      video.src=ch.url;
      await video.play();
      playerInstance=video;
    }

    // --- Wake Lock ---
    if('wakeLock' in navigator){
      try{
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release',()=>console.log("Screen Wake Lock released"));
      }catch(err){console.error(err);}
    }

  } catch(e){console.error(e);}
  loading.style.display="none";
  showChannelOSD(ch);
  updateUI();
}

// --- Grid / UI ---
function renderGrid(){
  grid.innerHTML="";
  const start=currentPage*pageSize, end=Math.min(start+pageSize,channels.length);
  channels.slice(start,end).forEach((ch,i)=>{
    const idx=start+i;
    const div=document.createElement("div");
    div.className="channel"+(idx===currentIndex?" active":"")+(idx===focusIndex?" focused":"");
    div.innerHTML=`<img src="${ch.logo}"><div>${ch.name}</div>`;
    grid.appendChild(div);
  });
  pageIndicator.textContent=`Trang ${currentPage+1} / ${Math.ceil(channels.length/pageSize)}`;
}
function updateUI(){ renderGrid(); epgDiv.textContent=`${channels[currentIndex].name} | ${channels[currentIndex].epg}`; }

// --- OSD ---
function showNumberOSD(num){ numberOSD.textContent=num; numberOSD.style.display="block"; }
function hideNumberOSD(){ numberOSD.style.display="none"; }
function showChannelOSD(ch){ osdLogo.src=ch.logo||""; osdName.textContent=ch.name; channelOSD.style.display="flex"; clearTimeout(osdTimer); osdTimer=setTimeout(()=>{channelOSD.style.display="none";},5000); }

// --- Remote Control ---
document.addEventListener("keydown",e=>{
  if(/^[0-9]$/.test(e.key)){ numberInput+=e.key; showNumberOSD(numberInput); clearTimeout(numberTimer); numberTimer=setTimeout(()=>{ const idx=parseInt(numberInput,10)-1; if(!isNaN(idx)) loadChannel(idx); numberInput=""; hideNumberOSD(); },1500); return; }
  if(!overlayVisible){
    if(e.key==="ArrowUp") loadChannel((currentIndex-1+channels.length)%channels.length);
    if(e.key==="ArrowDown") loadChannel((currentIndex+1)%channels.length);
    if(e.key==="Enter"){ overlayVisible=true; overlay.style.display="block"; focusIndex=currentIndex; renderGrid(); }
  } else {
    switch(e.key){
      case "ArrowUp": if(focusIndex-cols>=0) focusIndex-=cols; renderGrid(); break;
      case "ArrowDown": if(focusIndex+cols<channels.length) focusIndex+=cols; renderGrid(); break;
      case "ArrowLeft": if(focusIndex>0) focusIndex--; renderGrid(); break;
      case "ArrowRight": if(focusIndex<channels.length-1) focusIndex++; renderGrid(); break;
      case "PageUp": if(currentPage>0){currentPage--; focusIndex=currentPage*pageSize; renderGrid();} break;
      case "PageDown": if(currentPage<Math.ceil(channels.length/pageSize)-1){currentPage++; focusIndex=currentPage*pageSize; renderGrid();} break;
      case "Enter": loadChannel(focusIndex); overlayVisible=false; overlay.style.display="none"; break;
      case "Backspace": case "Escape": overlayVisible=false; overlay.style.display="none"; break;
    }
  }
});
document.addEventListener("keydown",e=>{ if(zapInterval) return; if(e.key==="ArrowUp") zapInterval=setInterval(()=>loadChannel((currentIndex-1+channels.length)%channels.length),800); if(e.key==="ArrowDown") zapInterval=setInterval(()=>loadChannel((currentIndex+1)%channels.length),800); });
document.addEventListener("keyup",()=>{ if(zapInterval){ clearInterval(zapInterval); zapInterval=null; } });

// --- Start ---
(async()=>{ channels=await loadM3U(M3U_URL); if(channels.length>0) loadChannel(0); else epgDiv.textContent="Không tìm thấy kênh trong M3U!"; })();
</script>
</body>
</html>