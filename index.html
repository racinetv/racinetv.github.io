<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>IPTV Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.3/shaka-player.compiled.js"></script>
  <style>
    body { margin:0; background:#000; color:#fff; font-family:sans-serif; overflow:hidden;}
    video { width:100%; height:100vh; object-fit:cover; background:#000; }

    /* Overlay danh sách kênh */
    #overlay {
      position:absolute; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.85); display:none; padding:20px;
    }
    #grid {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:16px;
    }
    .channel {
      background:rgba(255,255,255,0.05);
      border-radius:12px;
      text-align:center;
      padding:12px;
      transition:all 0.2s;
    }
    .channel img {
      width:100px; height:100px; object-fit:contain; margin-bottom:8px;
    }
    .channel.focused { outline:3px solid #00bfff; transform:scale(1.05);}
    .channel.active { background:rgba(0,191,255,0.3); }

    #epg {
      position:absolute; bottom:0; left:0; right:0;
      background:rgba(0,0,0,0.7); padding:12px; font-size:16px;
    }
    #page-indicator {
      position:absolute; top:10px; right:20px; font-size:14px; color:#bbb;
    }
    #number-osd {
      position:absolute; top:40%; left:50%; transform:translateX(-50%);
      font-size:48px; background:rgba(0,0,0,0.6); padding:20px 40px;
      border-radius:12px; display:none;
    }
    /* Mini OSD khi đổi kênh */
    #channel-osd {
      position:absolute; top:20px; left:20px;
      background:rgba(0,0,0,0.7); padding:10px 20px; border-radius:12px;
      display:none; align-items:center; gap:10px;
    }
    #channel-osd img { width:50px; height:50px; object-fit:contain; }
    #channel-osd span { font-size:18px; font-weight:bold; }

    /* Loading spinner */
    #loading {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      border:6px solid rgba(255,255,255,0.3);
      border-top:6px solid #00bfff;
      border-radius:50%; width:60px; height:60px;
      animation:spin 1s linear infinite;
      display:none;
    }
    @keyframes spin { 100% { transform:translate(-50%,-50%) rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Video player -->
  <video id="video" autoplay playsinline></video>

  <!-- Danh sách kênh -->
  <div id="overlay">
    <div id="page-indicator"></div>
    <div id="grid"></div>
  </div>

  <!-- EPG -->
  <div id="epg"></div>

  <!-- OSD nhập số -->
  <div id="number-osd"></div>

  <!-- Mini OSD kênh -->
  <div id="channel-osd"><img id="osd-logo"><span id="osd-name"></span></div>

  <!-- Loading -->
  <div id="loading"></div>

  <script>
    // --- CONFIG ---
    const M3U_URL = "https://raw.githubusercontent.com/vnrartv/vnrartv.github.io/main/racinetv_android_tv.m3u"; 
    const pageSize = 12;
    const cols = 4;

    // --- STATE ---
    let channels = [];
    let currentIndex = 0;
    let focusIndex = 0;
    let currentPage = 0;
    let overlayVisible = false;

    let numberInput = "";
    let numberTimer = null;
    let osdTimer = null;
    let zapInterval = null;
    let player = null;

    // --- DOM ---
    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const grid = document.getElementById("grid");
    const epgDiv = document.getElementById("epg");
    const pageIndicator = document.getElementById("page-indicator");
    const numberOSD = document.getElementById("number-osd");
    const channelOSD = document.getElementById("channel-osd");
    const osdLogo = document.getElementById("osd-logo");
    const osdName = document.getElementById("osd-name");
    const loading = document.getElementById("loading");

    // --- PARSE M3U ---
    async function loadM3U(url) {
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.split("\n");

      const result = [];
      let current = {};

      lines.forEach(line => {
        line = line.trim();
        if (line.startsWith("#EXTINF")) {
          const nameMatch = line.match(/,(.*)$/);
          const logoMatch = line.match(/tvg-logo="(.*?)"/);
          current = {
            name: nameMatch ? nameMatch[1] : "No name",
            logo: logoMatch ? logoMatch[1] : "",
          };
        } else if (line && !line.startsWith("#")) {
          current.url = line;
          current.epg = "Đang cập nhật...";
          result.push(current);
          current = {};
        }
      });

      return result;
    }

    // --- LOAD CHANNEL ---
    async function loadChannel(index) {
      if (index < 0 || index >= channels.length) return;
      currentIndex = index;
      const ch = channels[index];
      const url = ch.url.toLowerCase();

      loading.style.display = "block";

      if (player) {
        await player.destroy();
        player = null;
      }

      try {
        if (url.endsWith(".m3u8") || url.endsWith(".mpd")) {
          // --- Shaka Player cho HLS/DASH ---
          player = new shaka.Player(video);

          player.addEventListener("error", e => {
            console.error("Shaka error", e.detail);
            loading.style.display = "none";
          });

          await player.load(ch.url);

          // chọn chất lượng cao nhất
          const tracks = player.getVariantTracks();
          if (tracks.length > 0) {
            const best = tracks.reduce((a,b)=> a.bandwidth>b.bandwidth ? a : b);
            player.selectVariantTrack(best, true);
          }

          video.muted = false;
          await video.play();

          loading.style.display = "none";

        } else if (url.endsWith(".mp4") || url.endsWith(".ts") || url.endsWith(".mov") || url.endsWith(".mpeg") || url.endsWith(".php")) {
          // --- Dùng thẳng <video> ---
          video.src = ch.url;
          video.muted = false;
          video.play().catch(err=>console.error("Play error", err));
          video.oncanplay = () => loading.style.display = "none";
        } else {
          console.warn("Định dạng không được hỗ trợ:", ch.url);
          loading.style.display = "none";
        }
      } catch (err) {
        console.error("Load channel error", err);
        loading.style.display = "none";
      }

      showChannelOSD(ch);
      updateUI();
    }

    // --- RENDER GRID ---
    function renderGrid() {
      grid.innerHTML = "";
      const start = currentPage * pageSize;
      const end = Math.min(start + pageSize, channels.length);
      const visibleChannels = channels.slice(start, end);

      visibleChannels.forEach((ch,i)=>{
        const globalIndex = start + i;
        const div = document.createElement("div");
        div.className = "channel";
        if (globalIndex===currentIndex) div.classList.add("active");
        if (globalIndex===focusIndex) div.classList.add("focused");
        div.innerHTML = `<img src="${ch.logo}" alt=""><div>${ch.name}</div>`;
        grid.appendChild(div);
      });

      pageIndicator.textContent = `Trang ${currentPage+1} / ${Math.ceil(channels.length/pageSize)}`;
    }

    function updateUI() {
      renderGrid();
      epgDiv.textContent = `${channels[currentIndex].name} | ${channels[currentIndex].epg}`;
    }

    // --- OSD ---
    function showNumberOSD(num) {
      numberOSD.textContent = num;
      numberOSD.style.display = "block";
    }
    function hideNumberOSD() {
      numberOSD.style.display = "none";
    }
    function showChannelOSD(ch) {
      osdLogo.src = ch.logo || "";
      osdName.textContent = ch.name;
      channelOSD.style.display = "flex";
      clearTimeout(osdTimer);
      osdTimer = setTimeout(()=>{ channelOSD.style.display="none"; },3000);
    }

    // --- REMOTE CONTROL ---
    document.addEventListener("keydown",(e)=>{
      // chọn kênh bằng số
      if (/^[0-9]$/.test(e.key)) {
        numberInput += e.key;
        showNumberOSD(numberInput);
        clearTimeout(numberTimer);
        numberTimer = setTimeout(()=>{
          const index = parseInt(numberInput,10)-1;
          if (!isNaN(index)) loadChannel(index);
          numberInput="";
          hideNumberOSD();
        },1500);
        return;
      }

      if (!overlayVisible) {
        switch(e.key){
          case "ArrowUp":
            loadChannel((currentIndex-1+channels.length)%channels.length);
            break;
          case "ArrowDown":
            loadChannel((currentIndex+1)%channels.length);
            break;
          case "Enter":
            overlayVisible = true;
            overlay.style.display="block";
            focusIndex = currentIndex;
            renderGrid();
            break;
        }
      } else {
        switch(e.key){
          case "ArrowUp":
            if (focusIndex-cols>=0) focusIndex-=cols;
            renderGrid();
            break;
          case "ArrowDown":
            if (focusIndex+cols<channels.length) focusIndex+=cols;
            renderGrid();
            break;
          case "ArrowLeft":
            if (focusIndex>0) focusIndex--;
            renderGrid();
            break;
          case "ArrowRight":
            if (focusIndex<channels.length-1) focusIndex++;
            renderGrid();
            break;
          case "PageUp":
            if (currentPage>0) {
              currentPage--;
              focusIndex = currentPage*pageSize;
              renderGrid();
            }
            break;
          case "PageDown":
            if (currentPage<Math.ceil(channels.length/pageSize)-1) {
              currentPage++;
              focusIndex = currentPage*pageSize;
              renderGrid();
            }
            break;
          case "Enter":
            loadChannel(focusIndex);
            overlayVisible = false;
            overlay.style.display="none";
            break;
          case "Backspace":
          case "Escape":
            overlayVisible = false;
            overlay.style.display="none";
            break;
        }
      }
    });

    // Auto-zapping giữ phím
    document.addEventListener("keydown",(e)=>{
      if (zapInterval) return;
      if (e.key==="ArrowUp") {
        zapInterval = setInterval(()=> {
          loadChannel((currentIndex-1+channels.length)%channels.length);
        },800);
      }
      if (e.key==="ArrowDown") {
        zapInterval = setInterval(()=> {
          loadChannel((currentIndex+1)%channels.length);
        },800);
      }
    });
    document.addEventListener("keyup",()=>{   
      if (zapInterval) {
        clearInterval(zapInterval); 
        zapInterval=null;
      }
    });

    // --- START ---
    (async ()=>{
      channels = await loadM3U(M3U_URL);
      if (channels.length>0) {
        loadChannel(0); 
      } else {
        epgDiv.textContent = "Không tìm thấy kênh trong M3U!";
      }
    })();
  </script>
</body>
</html>